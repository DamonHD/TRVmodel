<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (19) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: org.hd.d.TRVmodel.hg, class: HGTRVHPMModelParameterised, record: HeatAndElectricityDemand">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">package org.hd.d.TRVmodel.hg;</span>
<span class="source-line-no">002</span><span id="line-2"></span>
<span class="source-line-no">003</span><span id="line-3">import java.util.Objects;</span>
<span class="source-line-no">004</span><span id="line-4"></span>
<span class="source-line-no">005</span><span id="line-5">/**Parameterised recreation of the heat-pump / TRV / energy interactions from Heat Geek's page:</span>
<span class="source-line-no">006</span><span id="line-6"> * &lt;a href="https://www.heatgeek.com/why-not-to-zone-heat-pumps-or-boilers/"&gt;https://www.heatgeek.com/why-not-to-zone-heat-pumps-or-boilers/&lt;/a&gt;</span>
<span class="source-line-no">007</span><span id="line-7"> * as of ~2023-06.</span>
<span class="source-line-no">008</span><span id="line-8"> * &lt;p&gt;</span>
<span class="source-line-no">009</span><span id="line-9"> * This is examining if turning down TRVs in unused rooms saves energy or not,</span>
<span class="source-line-no">010</span><span id="line-10"> * as is commonly assumed eg with gas-fired heating.</span>
<span class="source-line-no">011</span><span id="line-11"> * &lt;p&gt;</span>
<span class="source-line-no">012</span><span id="line-12"> * Many thanks to Heat Geek for making this analysis and explanation available.</span>
<span class="source-line-no">013</span><span id="line-13"> * &lt;p&gt;</span>
<span class="source-line-no">014</span><span id="line-14"> * This is a simple model, mirroring the page above.</span>
<span class="source-line-no">015</span><span id="line-15"> * &lt;p&gt;</span>
<span class="source-line-no">016</span><span id="line-16"> * This model is steady-state, ie in temperature equilibrium.</span>
<span class="source-line-no">017</span><span id="line-17"> * &lt;p&gt;</span>
<span class="source-line-no">018</span><span id="line-18"> * Note that the calculations are all stateless,</span>
<span class="source-line-no">019</span><span id="line-19"> * so could be memoised/cached for any particular set of input parameters.</span>
<span class="source-line-no">020</span><span id="line-20"> */</span>
<span class="source-line-no">021</span><span id="line-21">public final class HGTRVHPMModelParameterised</span>
<span class="source-line-no">022</span><span id="line-22">        {</span>
<span class="source-line-no">023</span><span id="line-23">        /**Prevent creation of an instance. */</span>
<span class="source-line-no">024</span><span id="line-24">    private HGTRVHPMModelParameterised() { }</span>
<span class="source-line-no">025</span><span id="line-25"></span>
<span class="source-line-no">026</span><span id="line-26">    /**Parameters for this version of the model.</span>
<span class="source-line-no">027</span><span id="line-27">     * Defaults should yield the same</span>
<span class="source-line-no">028</span><span id="line-28">     *</span>
<span class="source-line-no">029</span><span id="line-29">     * @param  doorsPerInternalWall  was 0.5 in the original page calcs (but 1 in the text);</span>
<span class="source-line-no">030</span><span id="line-30">     *     expected to be in range [0,1], must be finite and positive</span>
<span class="source-line-no">031</span><span id="line-31">     * @param correctCoPForFlowVsMW  if true then correct CoP flow temperature</span>
<span class="source-line-no">032</span><span id="line-32">     *     (original page implies false)</span>
<span class="source-line-no">033</span><span id="line-33">     * @param roomsAlternatingABAB  if true then arrange rooms to maximise internal heat transfer/loss</span>
<span class="source-line-no">034</span><span id="line-34">     *     else arrange so as to minimise heat loss</span>
<span class="source-line-no">035</span><span id="line-35">     *     (original page implies true)</span>
<span class="source-line-no">036</span><span id="line-36">     * @param externalAirTemperatureC  external air temperature, degrees C;</span>
<span class="source-line-no">037</span><span id="line-37">     *     (original page has -3&amp;deg;C)</span>
<span class="source-line-no">038</span><span id="line-38">     */</span>
<span class="source-line-no">039</span><span id="line-39">    public record ModelParameters(</span>
<span class="source-line-no">040</span><span id="line-40">                double doorsPerInternalWall,</span>
<span class="source-line-no">041</span><span id="line-41">                boolean correctCoPForFlowVsMW,</span>
<span class="source-line-no">042</span><span id="line-42">                boolean roomsAlternatingABAB,</span>
<span class="source-line-no">043</span><span id="line-43">                double externalAirTemperatureC</span>
<span class="source-line-no">044</span><span id="line-44">                )</span>
<span class="source-line-no">045</span><span id="line-45">            {</span>
<span class="source-line-no">046</span><span id="line-46">        public ModelParameters</span>
<span class="source-line-no">047</span><span id="line-47">                        {</span>
<span class="source-line-no">048</span><span id="line-48">                // Sanity-check parameters.</span>
<span class="source-line-no">049</span><span id="line-49">                if(!Double.isFinite(doorsPerInternalWall)) { throw new IllegalArgumentException(); }</span>
<span class="source-line-no">050</span><span id="line-50">                if(doorsPerInternalWall &lt; 0) { throw new IllegalArgumentException(); }</span>
<span class="source-line-no">051</span><span id="line-51">                        }</span>
<span class="source-line-no">052</span><span id="line-52"></span>
<span class="source-line-no">053</span><span id="line-53">        /**All-defaults parameter set the should produce original model results. */</span>
<span class="source-line-no">054</span><span id="line-54">        public ModelParameters()</span>
<span class="source-line-no">055</span><span id="line-55">                {</span>
<span class="source-line-no">056</span><span id="line-56">                this(</span>
<span class="source-line-no">057</span><span id="line-57">                        DEFAULT_DOORS_PER_INTERNAL_WALL,</span>
<span class="source-line-no">058</span><span id="line-58">                        DEFAULT_CORRECT_COP_FOR_FLOW_TEMPERATURE,</span>
<span class="source-line-no">059</span><span id="line-59">                        DEFAULT_ARRANGEMENT_ABAB,</span>
<span class="source-line-no">060</span><span id="line-60">                        DEFAULT_EXTERNAL_AIR_TEMPERATURE_C</span>
<span class="source-line-no">061</span><span id="line-61">                        );</span>
<span class="source-line-no">062</span><span id="line-62">                }</span>
<span class="source-line-no">063</span><span id="line-63"></span>
<span class="source-line-no">064</span><span id="line-64">        /**Allow doors per internal wall to be set, all else defaults. */</span>
<span class="source-line-no">065</span><span id="line-65">        public ModelParameters(final double doorsPerInternalWall, final boolean correctCoPForFlowVsMW)</span>
<span class="source-line-no">066</span><span id="line-66">            { this(doorsPerInternalWall, correctCoPForFlowVsMW, DEFAULT_ARRANGEMENT_ABAB, DEFAULT_EXTERNAL_AIR_TEMPERATURE_C); }</span>
<span class="source-line-no">067</span><span id="line-67"></span>
<span class="source-line-no">068</span><span id="line-68">        /**Allow doors per internal wall to be set, all else defaults. */</span>
<span class="source-line-no">069</span><span id="line-69">        public ModelParameters(final double doorsPerInternalWall)</span>
<span class="source-line-no">070</span><span id="line-70">            { this(doorsPerInternalWall, DEFAULT_CORRECT_COP_FOR_FLOW_TEMPERATURE); }</span>
<span class="source-line-no">071</span><span id="line-71"></span>
<span class="source-line-no">072</span><span id="line-72"></span>
<span class="source-line-no">073</span><span id="line-73">        /**Clone but replace external temperature value; all other parameters unchanged. */</span>
<span class="source-line-no">074</span><span id="line-74">        public ModelParameters cloneWithAdjustedExternalTemperature(final double newExternalTemperature)</span>
<span class="source-line-no">075</span><span id="line-75">                {</span>
<span class="source-line-no">076</span><span id="line-76">                if(!Double.isFinite(newExternalTemperature)) { throw new IllegalArgumentException(); }</span>
<span class="source-line-no">077</span><span id="line-77">                return(new ModelParameters(</span>
<span class="source-line-no">078</span><span id="line-78">                                doorsPerInternalWall,</span>
<span class="source-line-no">079</span><span id="line-79">                                correctCoPForFlowVsMW,</span>
<span class="source-line-no">080</span><span id="line-80">                                roomsAlternatingABAB,</span>
<span class="source-line-no">081</span><span id="line-81">                                newExternalTemperature));</span>
<span class="source-line-no">082</span><span id="line-82">                }</span>
<span class="source-line-no">083</span><span id="line-83"></span>
<span class="source-line-no">084</span><span id="line-84"></span>
<span class="source-line-no">085</span><span id="line-85">        /**Default doors per internal wall: matches the 0.5 in calcs on the original page. */</span>
<span class="source-line-no">086</span><span id="line-86">        public static final double DEFAULT_DOORS_PER_INTERNAL_WALL = 0.5;</span>
<span class="source-line-no">087</span><span id="line-87">        /**Default correction for CoP for flow rather than radiator mean water temperature. */</span>
<span class="source-line-no">088</span><span id="line-88">        public static final boolean DEFAULT_CORRECT_COP_FOR_FLOW_TEMPERATURE = false;</span>
<span class="source-line-no">089</span><span id="line-89">        /**Default room arrangement ABAB (vs AABB) alternating as original calcs. */</span>
<span class="source-line-no">090</span><span id="line-90">        public static final boolean DEFAULT_ARRANGEMENT_ABAB = true;</span>
<span class="source-line-no">091</span><span id="line-91">        /**Default external temperature (C). */</span>
<span class="source-line-no">092</span><span id="line-92">        public static final double DEFAULT_EXTERNAL_AIR_TEMPERATURE_C = HGTRVHPMModel.EXTERNAL_AIR_TEMPERATURE_C;</span>
<span class="source-line-no">093</span><span id="line-93"></span>
<span class="source-line-no">094</span><span id="line-94">        /**Fixed doors per internal wall: matches the 1 in text on the original page. */</span>
<span class="source-line-no">095</span><span id="line-95">        public static final double FIXED_DOORS_PER_INTERNAL_WALL = 1.0;</span>
<span class="source-line-no">096</span><span id="line-96">        /**Fixed correction for CoP for flow rather than radiator mean water temperature. */</span>
<span class="source-line-no">097</span><span id="line-97">        public static final boolean FIXED_CORRECT_COP_FOR_FLOW_TEMPERATURE = true;</span>
<span class="source-line-no">098</span><span id="line-98">        /**Version of parameters with fixes applied but no other changes from defaults. */</span>
<span class="source-line-no">099</span><span id="line-99">        public static final ModelParameters FIXES_APPLIED =</span>
<span class="source-line-no">100</span><span id="line-100">                        new ModelParameters(</span>
<span class="source-line-no">101</span><span id="line-101">                        ModelParameters.FIXED_DOORS_PER_INTERNAL_WALL,</span>
<span class="source-line-no">102</span><span id="line-102">                        ModelParameters.FIXED_CORRECT_COP_FOR_FLOW_TEMPERATURE);</span>
<span class="source-line-no">103</span><span id="line-103"></span>
<span class="source-line-no">104</span><span id="line-104">        /**AABB minimal-loss room arrangement. */</span>
<span class="source-line-no">105</span><span id="line-105">        public static final ModelParameters FIXES_AND_AABB =</span>
<span class="source-line-no">106</span><span id="line-106">                        new ModelParameters(</span>
<span class="source-line-no">107</span><span id="line-107">                        ModelParameters.FIXED_DOORS_PER_INTERNAL_WALL,</span>
<span class="source-line-no">108</span><span id="line-108">                        ModelParameters.FIXED_CORRECT_COP_FOR_FLOW_TEMPERATURE,</span>
<span class="source-line-no">109</span><span id="line-109">                        false,</span>
<span class="source-line-no">110</span><span id="line-110">                        DEFAULT_EXTERNAL_AIR_TEMPERATURE_C);</span>
<span class="source-line-no">111</span><span id="line-111">            }</span>
<span class="source-line-no">112</span><span id="line-112"></span>
<span class="source-line-no">113</span><span id="line-113">    /**Heat demand and the electricity input to the heat pump to meet it (W).</span>
<span class="source-line-no">114</span><span id="line-114">     * @param heatDemand  raw heat demand to maintain home temperature; finite, non-negative</span>
<span class="source-line-no">115</span><span id="line-115">     * @param heatPumpElectricity  electricity into the heat pump to maintain home temperature; finite, non-negative</span>
<span class="source-line-no">116</span><span id="line-116">     */</span>
<span class="source-line-no">117</span><span id="line-117">    public record HeatAndElectricityDemand(double heatDemand, double heatPumpElectricity)</span>
<span class="source-line-no">118</span><span id="line-118">            {</span>
<span class="source-line-no">119</span><span id="line-119">            public HeatAndElectricityDemand</span>
<span class="source-line-no">120</span><span id="line-120">                    {</span>
<span class="source-line-no">121</span><span id="line-121">                // Sanity-check parameters.</span>
<span class="source-line-no">122</span><span id="line-122">                if(!Double.isFinite(heatDemand)) { throw new IllegalArgumentException(); }</span>
<span class="source-line-no">123</span><span id="line-123">                if(heatDemand &lt; 0) { throw new IllegalArgumentException(); }</span>
<span class="source-line-no">124</span><span id="line-124">                if(!Double.isFinite(heatPumpElectricity)) { throw new IllegalArgumentException(); }</span>
<span class="source-line-no">125</span><span id="line-125">                if(heatPumpElectricity &lt; 0) { throw new IllegalArgumentException(); }</span>
<span class="source-line-no">126</span><span id="line-126">                    }</span>
<span class="source-line-no">127</span><span id="line-127">            }</span>
<span class="source-line-no">128</span><span id="line-128"></span>
<span class="source-line-no">129</span><span id="line-129">    /**Home heat and electricity demand with and without setback in B rooms; both non-null. */</span>
<span class="source-line-no">130</span><span id="line-130">    public record DemandWithoutAndWithSetback(HeatAndElectricityDemand noSetback, HeatAndElectricityDemand withSetback)</span>
<span class="source-line-no">131</span><span id="line-131">            {</span>
<span class="source-line-no">132</span><span id="line-132">        public DemandWithoutAndWithSetback</span>
<span class="source-line-no">133</span><span id="line-133">                {</span>
<span class="source-line-no">134</span><span id="line-134">                Objects.requireNonNull(noSetback);</span>
<span class="source-line-no">135</span><span id="line-135">                Objects.requireNonNull(withSetback);</span>
<span class="source-line-no">136</span><span id="line-136">                }</span>
<span class="source-line-no">137</span><span id="line-137">            }</span>
<span class="source-line-no">138</span><span id="line-138"></span>
<span class="source-line-no">139</span><span id="line-139">    /**Estimate the CoP for a given flow temperature (C) given the two supplied data points.</span>
<span class="source-line-no">140</span><span id="line-140">     * This does a simple linear fit, which is not perfect but probably adequate.</span>
<span class="source-line-no">141</span><span id="line-141">     * &lt;p&gt;</span>
<span class="source-line-no">142</span><span id="line-142">     * Note this is for flow temperature, given the sample manufacturer's data,</span>
<span class="source-line-no">143</span><span id="line-143">     * though the original text uses this interchangeably with mid temperature.</span>
<span class="source-line-no">144</span><span id="line-144">     */</span>
<span class="source-line-no">145</span><span id="line-145">    public static double computeFlowCoP(final double flowC)</span>
<span class="source-line-no">146</span><span id="line-146">            {</span>
<span class="source-line-no">147</span><span id="line-147">        final double lowerTempC = 46.0;</span>
<span class="source-line-no">148</span><span id="line-148">        final double upperTempC = 51.5;</span>
<span class="source-line-no">149</span><span id="line-149">        final double tempDeltaK = upperTempC - lowerTempC;</span>
<span class="source-line-no">150</span><span id="line-150">        final double CoPDelta = HGTRVHPMModel.COP_AT_51p5C - HGTRVHPMModel.COP_AT_46p0C;</span>
<span class="source-line-no">151</span><span id="line-151"></span>
<span class="source-line-no">152</span><span id="line-152">        final double CoP = HGTRVHPMModel.COP_AT_46p0C +</span>
<span class="source-line-no">153</span><span id="line-153">                        ((flowC - lowerTempC) * (CoPDelta / tempDeltaK));</span>
<span class="source-line-no">154</span><span id="line-154"></span>
<span class="source-line-no">155</span><span id="line-155">        return(CoP);</span>
<span class="source-line-no">156</span><span id="line-156">            }</span>
<span class="source-line-no">157</span><span id="line-157"></span>
<span class="source-line-no">158</span><span id="line-158">    /**Assumed delta between MW and flow temperature with 5K system delta (K). */</span>
<span class="source-line-no">159</span><span id="line-159">    public static final double flowMWDelta_K = 2.5;</span>
<span class="source-line-no">160</span><span id="line-160"></span>
<span class="source-line-no">161</span><span id="line-161">    /**Compute the original HG 4-room 'bungalow' heat-pump electricity demand (W); zero or more.</span>
<span class="source-line-no">162</span><span id="line-162">     * The calculation uses constants from HGTRVHPMModel as far as possible,</span>
<span class="source-line-no">163</span><span id="line-163">     * substituting in parameters and new calculation where needed.</span>
<span class="source-line-no">164</span><span id="line-164">     *</span>
<span class="source-line-no">165</span><span id="line-165">     * @param params  the variable model parameters</span>
<span class="source-line-no">166</span><span id="line-166">     * @param withBSetback  if true, with B rooms set back, else all at same temperature</span>
<span class="source-line-no">167</span><span id="line-167">     * @return  demand in watts, finite and non-negative</span>
<span class="source-line-no">168</span><span id="line-168">     */</span>
<span class="source-line-no">169</span><span id="line-169">    public static double computeBungalowHPElectricityDemandW(final ModelParameters params, final boolean withBSetback)</span>
<span class="source-line-no">170</span><span id="line-170">            {</span>
<span class="source-line-no">171</span><span id="line-171">        Objects.requireNonNull(params);</span>
<span class="source-line-no">172</span><span id="line-172">        return(withBSetback ?</span>
<span class="source-line-no">173</span><span id="line-173">                        computeBungalowDemandW(params).withSetback.heatPumpElectricity :</span>
<span class="source-line-no">174</span><span id="line-174">                        computeBungalowDemandW(params).noSetback.heatPumpElectricity);</span>
<span class="source-line-no">175</span><span id="line-175">            }</span>
<span class="source-line-no">176</span><span id="line-176"></span>
<span class="source-line-no">177</span><span id="line-177">    /**Radiator mean water temperature in each A room when B setback (C).</span>
<span class="source-line-no">178</span><span id="line-178">     * @param HHLsb  whole home heat loss with B rooms setback and given external air temperature (W)</span>
<span class="source-line-no">179</span><span id="line-179">     * @param radWnsb  pre-setback radiator output based on variable external air temperature (W)</span>
<span class="source-line-no">180</span><span id="line-180">     * @param IWFAabHLW  internal wall/floor heat loss/transfer per A room (W)</span>
<span class="source-line-no">181</span><span id="line-181">     * @return (radAsbMW) mean water temperature in each A room when B setback (C)</span>
<span class="source-line-no">182</span><span id="line-182">     */</span>
<span class="source-line-no">183</span><span id="line-183">        public static double sbAMW(final double HHLsb, final double radWnsb, final double IWAabHLW)</span>
<span class="source-line-no">184</span><span id="line-184">                {</span>
<span class="source-line-no">185</span><span id="line-185">                // radWAsb: (Heat Loss 2.0) radiator output in each A room when B setback (W).</span>
<span class="source-line-no">186</span><span id="line-186">        // (RADIATOR_POWER_IN_A_ROOMS_WHEN_B_SETBACK_W)</span>
<span class="source-line-no">187</span><span id="line-187">        final double radWAsb =</span>
<span class="source-line-no">188</span><span id="line-188">                //HGTRVHPMModel.RADIATOR_POWER_WITH_HOME_AT_NORMAL_ROOM_TEMPERATURE_W + IDWAabHLW;</span>
<span class="source-line-no">189</span><span id="line-189">                radWnsb + IWAabHLW;</span>
<span class="source-line-no">190</span><span id="line-190">        // radWBbs: (Heat Loss 2.0) radiator output in each B room when B setback (W).</span>
<span class="source-line-no">191</span><span id="line-191">        // (Was: RADIATOR_POWER_IN_B_ROOMS_WHEN_B_SETBACK_W)</span>
<span class="source-line-no">192</span><span id="line-192">// TODO: why unused: radWBsb</span>
<span class="source-line-no">193</span><span id="line-193">//        final double radWBsb =</span>
<span class="source-line-no">194</span><span id="line-194">//              (HHLsb - 2*radWAsb) / 2;</span>
<span class="source-line-no">195</span><span id="line-195">        // radWAmult: (Heat Loss 2.1) radiator output increase multiplier in each A room when B setback.</span>
<span class="source-line-no">196</span><span id="line-196">        // (RADIATOR_POWER_UPLIFT_IN_A_ROOMS_WHEN_B_SETBACK_MULTIPLIER)</span>
<span class="source-line-no">197</span><span id="line-197">        final double radWAmult =</span>
<span class="source-line-no">198</span><span id="line-198">                radWAsb / HGTRVHPMModel.RADIATOR_POWER_WITH_HOME_AT_NORMAL_ROOM_TEMPERATURE_W;</span>
<span class="source-line-no">199</span><span id="line-199">        // radAsbdTmult: (Heat Loss 2.3) radiator MW-AT delta-T increase multiplier in each A room when B setback.</span>
<span class="source-line-no">200</span><span id="line-200">        // (RADIATOR_DT_UPLIFT_IN_A_ROOMS_WHEN_B_SETBACK_MULTIPLIER)</span>
<span class="source-line-no">201</span><span id="line-201">        final double radAsbdTmult =</span>
<span class="source-line-no">202</span><span id="line-202">                Math.pow(radWAmult, HGTRVHPMModel.RADIATOR_EXP_POWER_TO_DT);</span>
<span class="source-line-no">203</span><span id="line-203">        // radAsbdT: (Heat Loss 2.4) radiator MW-AT delta-T in each A room when B setback (K).</span>
<span class="source-line-no">204</span><span id="line-204">        // (RADIATOR_DT_IN_A_ROOMS_WHEN_B_SETBACK_K)</span>
<span class="source-line-no">205</span><span id="line-205">        final double radAsbdT =</span>
<span class="source-line-no">206</span><span id="line-206">                HGTRVHPMModel.RADIATOR_MWATDT_AT_NORMAL_ROOM_TEMPERATURE_K * radAsbdTmult;</span>
<span class="source-line-no">207</span><span id="line-207">        // radAsbMW: (Heat Loss 2.5) radiator mean water temperature in each A room when B setback (C).</span>
<span class="source-line-no">208</span><span id="line-208">        // (RADIATOR_MW_IN_A_ROOMS_WHEN_B_SETBACK_C)</span>
<span class="source-line-no">209</span><span id="line-209">        final double radAsbMW =</span>
<span class="source-line-no">210</span><span id="line-210">                HGTRVHPMModel.NORMAL_ROOM_TEMPERATURE_C + radAsbdT;</span>
<span class="source-line-no">211</span><span id="line-211">//System.out.println(String.format("radAbsMW = %.1f", radAbsMW));</span>
<span class="source-line-no">212</span><span id="line-212">                return(radAsbMW);</span>
<span class="source-line-no">213</span><span id="line-213">                }</span>
<span class="source-line-no">214</span><span id="line-214"></span>
<span class="source-line-no">215</span><span id="line-215">    /**Internal wall heat loss/transfer per A room (HEAT LOSS 1) with A at 'normal' temperature (W).     *</span>
<span class="source-line-no">216</span><span id="line-216">     * @param params  the model parameters; never null</span>
<span class="source-line-no">217</span><span id="line-217">     */</span>
<span class="source-line-no">218</span><span id="line-218">        private static double iwHeatLossPerA(final ModelParameters params)</span>
<span class="source-line-no">219</span><span id="line-219">                {</span>
<span class="source-line-no">220</span><span id="line-220">                return(iwHeatLossPerA(params, HGTRVHPMModel.NORMAL_ROOM_TEMPERATURE_C));</span>
<span class="source-line-no">221</span><span id="line-221">                }</span>
<span class="source-line-no">222</span><span id="line-222"></span>
<span class="source-line-no">223</span><span id="line-223">    /**Internal wall heat loss/transfer per A room (HEAT LOSS 1) (W).</span>
<span class="source-line-no">224</span><span id="line-224">     * This allows an A room temperature other than the initial 'normal' 21C,</span>
<span class="source-line-no">225</span><span id="line-225">     * though it must still be above the B room setback temperature.</span>
<span class="source-line-no">226</span><span id="line-226">     *</span>
<span class="source-line-no">227</span><span id="line-227">     * @param params  the model parameters; never null</span>
<span class="source-line-no">228</span><span id="line-228">     * @param tempA  the A room temperature in C; no lower than B (and finite)</span>
<span class="source-line-no">229</span><span id="line-229">     */</span>
<span class="source-line-no">230</span><span id="line-230">        private static double iwHeatLossPerA(final ModelParameters params, final double tempA)</span>
<span class="source-line-no">231</span><span id="line-231">            {</span>
<span class="source-line-no">232</span><span id="line-232">                Objects.requireNonNull(params);</span>
<span class="source-line-no">233</span><span id="line-233">                if(!(tempA &gt;= HGTRVHPMModel.SETBACK_ROOM_TEMPERATURE_C)) { throw new IllegalArgumentException("A must be warmer than B"); }</span>
<span class="source-line-no">234</span><span id="line-234"></span>
<span class="source-line-no">235</span><span id="line-235">                // IWAabmd: (Heat Loss 1.2) internal wall area between each A and adjoining B rooms minus appropriate amount of door (m^2).</span>
<span class="source-line-no">236</span><span id="line-236">        // (INTERNAL_WALL_AREA_FROM_EACH_A_TO_B_ROOMS_MINUS_DOOR_M2)</span>
<span class="source-line-no">237</span><span id="line-237">        final double IWAabmd =</span>
<span class="source-line-no">238</span><span id="line-238">                        HGTRVHPMModel.INTERNAL_WALL_AREA_FROM_EACH_A_TO_B_ROOM_M2</span>
<span class="source-line-no">239</span><span id="line-239">                        - (2 * params.doorsPerInternalWall() * HGTRVHPMModel.INTERNAL_DOOR_AREA_PER_DOOR_M2);</span>
<span class="source-line-no">240</span><span id="line-240">        // IWAabHL: (Heat Loss 1.3) internal wall (minus door) heat loss per Kelvin (W/K).</span>
<span class="source-line-no">241</span><span id="line-241">        // (INTERNAL_WALL_MINUS_DOOR_HEAT_LOSS_PER_KELVIN_WpK)</span>
<span class="source-line-no">242</span><span id="line-242">        final double IWAabHL =</span>
<span class="source-line-no">243</span><span id="line-243">                IWAabmd * HGTRVHPMModel.INTERNAL_WALL_U_WpM2K;</span>
<span class="source-line-no">244</span><span id="line-244">        // IWAabHLW: (Heat Loss 1.4) internal wall (minus door) heat loss (W).</span>
<span class="source-line-no">245</span><span id="line-245">        // (INTERNAL_WALL_MINUS_DOOR_HEAT_LOSS_W)</span>
<span class="source-line-no">246</span><span id="line-246">        final double IWAabHLW =</span>
<span class="source-line-no">247</span><span id="line-247">                IWAabHL *</span>
<span class="source-line-no">248</span><span id="line-248">                        (tempA - HGTRVHPMModel.SETBACK_ROOM_TEMPERATURE_C);</span>
<span class="source-line-no">249</span><span id="line-249">        // IDAabHL: (Heat Loss 1.5) internal door heat loss per door per Kelvin (W/K).</span>
<span class="source-line-no">250</span><span id="line-250">        // (INTERNAL_DOOR_HEAT_LOSS_PER_KELVIN_WpK)</span>
<span class="source-line-no">251</span><span id="line-251">        final double IDAabHL =</span>
<span class="source-line-no">252</span><span id="line-252">                HGTRVHPMModel.INTERNAL_DOOR_AREA_PER_DOOR_M2 * HGTRVHPMModel.INTERNAL_DOOR_U_WpM2K;</span>
<span class="source-line-no">253</span><span id="line-253">        // IDAabHLW: (Heat Loss 1.6) internal door heat loss per door (W).</span>
<span class="source-line-no">254</span><span id="line-254">        // (INTERNAL_DOOR_HEAT_LOSS_W)</span>
<span class="source-line-no">255</span><span id="line-255">        final double IDAabHLW =</span>
<span class="source-line-no">256</span><span id="line-256">                IDAabHL *</span>
<span class="source-line-no">257</span><span id="line-257">                    (tempA - HGTRVHPMModel.SETBACK_ROOM_TEMPERATURE_C);</span>
<span class="source-line-no">258</span><span id="line-258">        // IDWAabHLW: (Heat Loss 1.7) internal wall and door heat loss per A room (W).</span>
<span class="source-line-no">259</span><span id="line-259">        // (INTERNAL_WALL_AND_DOOR_HEAT_LOSS_PER_A_ROOM_W)</span>
<span class="source-line-no">260</span><span id="line-260">        // In the original ABAB arrangement there are two walls from each A room into B rooms.</span>
<span class="source-line-no">261</span><span id="line-261">        // In the alternate AABB arrangement there is one wall from each A room into a B room.</span>
<span class="source-line-no">262</span><span id="line-262">        // Thus AABB has half the internal heat loss of ABAB.</span>
<span class="source-line-no">263</span><span id="line-263">        final double IDWAabHLW = ((params.roomsAlternatingABAB()) ? 1 : 0.5) *</span>
<span class="source-line-no">264</span><span id="line-264">                        (IWAabHLW + (2 * params.doorsPerInternalWall() * IDAabHLW));</span>
<span class="source-line-no">265</span><span id="line-265"></span>
<span class="source-line-no">266</span><span id="line-266">// DHD20231127: bug present in V0.9.4 ie missing brackets around wall and door terms // ((params.roomsAlternatingABAB()) ? 1 : 0.5) * /*(*/ IWAabHLW + (2 * params.doorsPerInternalWall() * IDAabHLW) /*)*/;</span>
<span class="source-line-no">267</span><span id="line-267"></span>
<span class="source-line-no">268</span><span id="line-268">                return(IDWAabHLW);</span>
<span class="source-line-no">269</span><span id="line-269">            }</span>
<span class="source-line-no">270</span><span id="line-270"></span>
<span class="source-line-no">271</span><span id="line-271">    /**Internal floor/ceiling heat loss/transfer per A room (W) for 2-storey detached.</span>
<span class="source-line-no">272</span><span id="line-272">     * Only applies when a B room is directly above or below.</span>
<span class="source-line-no">273</span><span id="line-273">     * &lt;p&gt;</span>
<span class="source-line-no">274</span><span id="line-274">     * This is only for a 2-storey detached, so in an ABAB arrangement (with BABA below)</span>
<span class="source-line-no">275</span><span id="line-275">     * each A room will lose each &lt;em&gt;either&lt;/em&gt; to a B room below or above (not both).</span>
<span class="source-line-no">276</span><span id="line-276">     * Heat loss in each direction (up or down) is treated as the same.</span>
<span class="source-line-no">277</span><span id="line-277">     * &lt;p&gt;</span>
<span class="source-line-no">278</span><span id="line-278">     * Assumes that A room is at 'normal' temperature and B room is at setback temperature.</span>
<span class="source-line-no">279</span><span id="line-279">     *</span>
<span class="source-line-no">280</span><span id="line-280">     * @param params  model parameters; non-null</span>
<span class="source-line-no">281</span><span id="line-281">     */</span>
<span class="source-line-no">282</span><span id="line-282">        private static double ifHeatLossPerA2Storey(final ModelParameters params)</span>
<span class="source-line-no">283</span><span id="line-283">                {</span>
<span class="source-line-no">284</span><span id="line-284">                return(ifHeatLossPerA2Storey(params, HGTRVHPMModel.NORMAL_ROOM_TEMPERATURE_C));</span>
<span class="source-line-no">285</span><span id="line-285">                }</span>
<span class="source-line-no">286</span><span id="line-286"></span>
<span class="source-line-no">287</span><span id="line-287">    /**Internal floor/ceiling heat loss/transfer per A room (W) for 2-storey detached.</span>
<span class="source-line-no">288</span><span id="line-288">     * Only applies when a B room is directly above or below.</span>
<span class="source-line-no">289</span><span id="line-289">     * &lt;p&gt;</span>
<span class="source-line-no">290</span><span id="line-290">     * This is only for a 2-storey detached, so in an ABAB arrangement (with BABA below)</span>
<span class="source-line-no">291</span><span id="line-291">     * each A room will lose each &lt;em&gt;either&lt;/em&gt; to a B room below or above (not both).</span>
<span class="source-line-no">292</span><span id="line-292">     * Heat loss in each direction (up or down) is treated as the same.</span>
<span class="source-line-no">293</span><span id="line-293">     *</span>
<span class="source-line-no">294</span><span id="line-294">     * @param params  model parameters; non-null</span>
<span class="source-line-no">295</span><span id="line-295">     * @param tempA  temperature of A room, must be no lower than B room setback.</span>
<span class="source-line-no">296</span><span id="line-296">     */</span>
<span class="source-line-no">297</span><span id="line-297">        private static double ifHeatLossPerA2Storey(final ModelParameters params, final double tempA)</span>
<span class="source-line-no">298</span><span id="line-298">                {</span>
<span class="source-line-no">299</span><span id="line-299">                if(!(tempA &gt;= HGTRVHPMModel.SETBACK_ROOM_TEMPERATURE_C)) { throw new IllegalArgumentException("A must be warmer than B"); }</span>
<span class="source-line-no">300</span><span id="line-300"></span>
<span class="source-line-no">301</span><span id="line-301">                if(!params.roomsAlternatingABAB) { return(0); }</span>
<span class="source-line-no">302</span><span id="line-302"></span>
<span class="source-line-no">303</span><span id="line-303">        // IFAabHL: internal floor/ceiling heat loss per Kelvin (W/K).</span>
<span class="source-line-no">304</span><span id="line-304">        final double IFAabHL =</span>
<span class="source-line-no">305</span><span id="line-305">                HGTRVHPMModelExtensions.PER_A_FLOOR_AREA_M2 * HGTRVHPMModelExtensions.INTERNAL_FLOOR_U_WpM2K;</span>
<span class="source-line-no">306</span><span id="line-306"></span>
<span class="source-line-no">307</span><span id="line-307">        // IFAabHLW: internal floor/ceiling heat loss per A room (W).</span>
<span class="source-line-no">308</span><span id="line-308">        final double IFAabHLW =</span>
<span class="source-line-no">309</span><span id="line-309">                IFAabHL *</span>
<span class="source-line-no">310</span><span id="line-310">                        (tempA - HGTRVHPMModel.SETBACK_ROOM_TEMPERATURE_C);</span>
<span class="source-line-no">311</span><span id="line-311"></span>
<span class="source-line-no">312</span><span id="line-312">                return(IFAabHLW);</span>
<span class="source-line-no">313</span><span id="line-313">                }</span>
<span class="source-line-no">314</span><span id="line-314"></span>
<span class="source-line-no">315</span><span id="line-315">        /**Compute radiator mean water temperature in each A room when B is NOT set back (C).</span>
<span class="source-line-no">316</span><span id="line-316">         * Extension to heat loss 2 to allow for varying external temperatures.</span>
<span class="source-line-no">317</span><span id="line-317">         * &lt;p&gt;</span>
<span class="source-line-no">318</span><span id="line-318">         * This is in fact the MW temperature for all room radiators when there are no setbacks.</span>
<span class="source-line-no">319</span><span id="line-319">         *</span>
<span class="source-line-no">320</span><span id="line-320">         * @param radWnsb  pre-setback radiator output based on variable external air temperature (W)</span>
<span class="source-line-no">321</span><span id="line-321">         * @return (radAnsbMW) radiator mean water temperature in each A room when B is NOT set back (C)</span>
<span class="source-line-no">322</span><span id="line-322">         */</span>
<span class="source-line-no">323</span><span id="line-323">        public static double nsbAMW(final double radWnsb)</span>
<span class="source-line-no">324</span><span id="line-324">                {</span>
<span class="source-line-no">325</span><span id="line-325">                // Extension to heat loss 2 to allow for varying external temperatures.</span>
<span class="source-line-no">326</span><span id="line-326">        // Compute, for when B rooms are not set back:</span>
<span class="source-line-no">327</span><span id="line-327">        //   * the needed power for each A radiator</span>
<span class="source-line-no">328</span><span id="line-328">        //   * thus the implied radiator mean water temperature</span>
<span class="source-line-no">329</span><span id="line-329">                //</span>
<span class="source-line-no">330</span><span id="line-330">                // This then allows computing:</span>
<span class="source-line-no">331</span><span id="line-331">        //   * the CoP</span>
<span class="source-line-no">332</span><span id="line-332">        //   * the heat-pump electricity demand</span>
<span class="source-line-no">333</span><span id="line-333">        //</span>
<span class="source-line-no">334</span><span id="line-334">        // Replaces the simple calc;</span>
<span class="source-line-no">335</span><span id="line-335">//     final double radAMW =</span>
<span class="source-line-no">336</span><span id="line-336">//         HGTRVHPMModel.NORMAL_ROOM_TEMPERATURE_C + HGTRVHPMModel.RADIATOR_MWATDT_AT_NORMAL_ROOM_TEMPERATURE_K;</span>
<span class="source-line-no">337</span><span id="line-337">        //</span>
<span class="source-line-no">338</span><span id="line-338">        // radWAnsbmult: (Heat Loss 2.1) radiator output (possibly &lt; 1) multiplier in each A room when B is not setback.</span>
<span class="source-line-no">339</span><span id="line-339">        // (RADIATOR_POWER_UPLIFT_IN_A_ROOMS_WHEN_B_SETBACK_MULTIPLIER)</span>
<span class="source-line-no">340</span><span id="line-340">        final double radWAnsbmult =</span>
<span class="source-line-no">341</span><span id="line-341">                radWnsb / HGTRVHPMModel.RADIATOR_POWER_WITH_HOME_AT_NORMAL_ROOM_TEMPERATURE_W;</span>
<span class="source-line-no">342</span><span id="line-342">//System.out.println(String.format("radWAnsbmult = %f", radWAnsbmult));</span>
<span class="source-line-no">343</span><span id="line-343"></span>
<span class="source-line-no">344</span><span id="line-344">                // radAnsbdTmult: radiator MW-AT delta-T multiplier in each A room when B NOT setback.</span>
<span class="source-line-no">345</span><span id="line-345">                final double radAnsbdTmult =</span>
<span class="source-line-no">346</span><span id="line-346">                        Math.pow(radWAnsbmult, HGTRVHPMModel.RADIATOR_EXP_POWER_TO_DT);</span>
<span class="source-line-no">347</span><span id="line-347">                // radAnsbdT: radiator MW-AT delta-T in each A room when B NOT setback (K).</span>
<span class="source-line-no">348</span><span id="line-348">                final double radAnsbdT =</span>
<span class="source-line-no">349</span><span id="line-349">                        HGTRVHPMModel.RADIATOR_MWATDT_AT_NORMAL_ROOM_TEMPERATURE_K * radAnsbdTmult;</span>
<span class="source-line-no">350</span><span id="line-350">                // radAnsbMW: radiator mean water temperature in each A room when B NOT setback (C).</span>
<span class="source-line-no">351</span><span id="line-351">                final double radAnsbMW =</span>
<span class="source-line-no">352</span><span id="line-352">                        HGTRVHPMModel.NORMAL_ROOM_TEMPERATURE_C + radAnsbdT;</span>
<span class="source-line-no">353</span><span id="line-353">//System.out.println(String.format("radAnbsMW = %.1f", radAnbsMW));</span>
<span class="source-line-no">354</span><span id="line-354">                return(radAnsbMW);</span>
<span class="source-line-no">355</span><span id="line-355">                }</span>
<span class="source-line-no">356</span><span id="line-356"></span>
<span class="source-line-no">357</span><span id="line-357">    /**Compute the original HG 4-room 'bungalow' raw heat and heat-pump electricity demand with and without B-room setback (W).</span>
<span class="source-line-no">358</span><span id="line-358">     * The calculation uses constants from HGTRVHPMModel as far as possible,</span>
<span class="source-line-no">359</span><span id="line-359">     * substituting in parameters and new calculation where needed.</span>
<span class="source-line-no">360</span><span id="line-360">     *</span>
<span class="source-line-no">361</span><span id="line-361">     * @param params  the variable model parameters</span>
<span class="source-line-no">362</span><span id="line-362">     * @return  demand in watts, finite and non-negative</span>
<span class="source-line-no">363</span><span id="line-363">     */</span>
<span class="source-line-no">364</span><span id="line-364">    public static DemandWithoutAndWithSetback computeBungalowDemandW(final ModelParameters params)</span>
<span class="source-line-no">365</span><span id="line-365">            {</span>
<span class="source-line-no">366</span><span id="line-366">        Objects.requireNonNull(params);</span>
<span class="source-line-no">367</span><span id="line-367"></span>
<span class="source-line-no">368</span><span id="line-368"></span>
<span class="source-line-no">369</span><span id="line-369">        // Do not allow model to be run with potentially implausible parameters.</span>
<span class="source-line-no">370</span><span id="line-370">        if(params.externalAirTemperatureC &gt;= HGTRVHPMModel.SETBACK_ROOM_TEMPERATURE_C)</span>
<span class="source-line-no">371</span><span id="line-371">            { throw new UnsupportedOperationException("model may not work when outside is warmer than setback rooms"); }</span>
<span class="source-line-no">372</span><span id="line-372"></span>
<span class="source-line-no">373</span><span id="line-373"></span>
<span class="source-line-no">374</span><span id="line-374">        // HHLnsb: whole home heat loss with no setback (all rooms same temperature) and given external air temperature (W).</span>
<span class="source-line-no">375</span><span id="line-375">        final double HHLnsb = (HGTRVHPMModel.NORMAL_ROOM_TEMPERATURE_C - params.externalAirTemperatureC()) *</span>
<span class="source-line-no">376</span><span id="line-376">                        HGTRVHPMModel.HOME_HEAT_LOSS_PER_KELVIN_WpK;</span>
<span class="source-line-no">377</span><span id="line-377">        // HHLsb: whole home heat loss with B rooms setback and given external air temperature (W).</span>
<span class="source-line-no">378</span><span id="line-378">        final double HHLsb = (HGTRVHPMModel.MEAN_HOME_TEMPERATURE_WITH_SETBACK_C - params.externalAirTemperatureC()) *</span>
<span class="source-line-no">379</span><span id="line-379">                        HGTRVHPMModel.HOME_HEAT_LOSS_PER_KELVIN_WpK;</span>
<span class="source-line-no">380</span><span id="line-380">                // radWnbs: (Flow Temperature, step 1) pre-setback radiator output based on variable external air temperature (W).</span>
<span class="source-line-no">381</span><span id="line-381">        // (Was: RADIATOR_POWER_WITH_HOME_AT_NORMAL_ROOM_TEMPERATURE_W.)</span>
<span class="source-line-no">382</span><span id="line-382">                final double radWnsb = HHLnsb / 4;</span>
<span class="source-line-no">383</span><span id="line-383"></span>
<span class="source-line-no">384</span><span id="line-384"></span>
<span class="source-line-no">385</span><span id="line-385">        // HEAT LOSS 1</span>
<span class="source-line-no">386</span><span id="line-386">                // Internal wall heat loss/transfer per A room (W).</span>
<span class="source-line-no">387</span><span id="line-387">        final double IDWAabHLW = iwHeatLossPerA(params);</span>
<span class="source-line-no">388</span><span id="line-388"></span>
<span class="source-line-no">389</span><span id="line-389"></span>
<span class="source-line-no">390</span><span id="line-390">        // HEAT LOSS 2</span>
<span class="source-line-no">391</span><span id="line-391">        // radAsbMW: (Heat Loss 2.5) radiator mean water temperature in each A room when B setback (C).</span>
<span class="source-line-no">392</span><span id="line-392">        final double radAsbMW = sbAMW(HHLsb, radWnsb, IDWAabHLW);</span>
<span class="source-line-no">393</span><span id="line-393">                // Extension to heat loss 2 to allow for varying external temperatures.</span>
<span class="source-line-no">394</span><span id="line-394">        final double radAnsbMW = nsbAMW(radWnsb);</span>
<span class="source-line-no">395</span><span id="line-395"></span>
<span class="source-line-no">396</span><span id="line-396"></span>
<span class="source-line-no">397</span><span id="line-397">        final double CoPCorrectionK = params.correctCoPForFlowVsMW ? flowMWDelta_K : 0;</span>
<span class="source-line-no">398</span><span id="line-398"></span>
<span class="source-line-no">399</span><span id="line-399">                // HPinWnsb: (Heat Pump Efficiency) heat-pump electrical power in when B not setback (W).</span>
<span class="source-line-no">400</span><span id="line-400">        // (HEAT_PUMP_POWER_IN_NO_SETBACK_W)</span>
<span class="source-line-no">401</span><span id="line-401">        // Note that flow and mean temperatures seem to be being mixed here in the HG page.</span>
<span class="source-line-no">402</span><span id="line-402">        final double CoPnsb = computeFlowCoP(radAnsbMW + CoPCorrectionK);</span>
<span class="source-line-no">403</span><span id="line-403">//System.out.println(String.format("CoPnsb = %f", CoPnsb));</span>
<span class="source-line-no">404</span><span id="line-404">        final double HPinWnsb =</span>
<span class="source-line-no">405</span><span id="line-405">                HHLnsb / CoPnsb;</span>
<span class="source-line-no">406</span><span id="line-406"></span>
<span class="source-line-no">407</span><span id="line-407">                // HPinWsb: (Heat Pump Efficiency) heat-pump electrical power in when B is setback (W).</span>
<span class="source-line-no">408</span><span id="line-408">        // (HEAT_PUMP_POWER_IN_B_SETBACK_W)</span>
<span class="source-line-no">409</span><span id="line-409">        // Note that flow and mean temperatures seem to be being mixed here in the HG page.</span>
<span class="source-line-no">410</span><span id="line-410">        final double CoPsb = computeFlowCoP(radAsbMW + CoPCorrectionK);</span>
<span class="source-line-no">411</span><span id="line-411">//System.out.println(String.format("CoPsb = %f", CoPsb));</span>
<span class="source-line-no">412</span><span id="line-412">        final double HPinWsb =</span>
<span class="source-line-no">413</span><span id="line-413">                HHLsb / CoPsb;</span>
<span class="source-line-no">414</span><span id="line-414"></span>
<span class="source-line-no">415</span><span id="line-415"></span>
<span class="source-line-no">416</span><span id="line-416">        final HeatAndElectricityDemand noSetback = new HeatAndElectricityDemand(HHLnsb, HPinWnsb);</span>
<span class="source-line-no">417</span><span id="line-417">        final HeatAndElectricityDemand withSetback = new HeatAndElectricityDemand(HHLsb, HPinWsb);</span>
<span class="source-line-no">418</span><span id="line-418"></span>
<span class="source-line-no">419</span><span id="line-419">        // Return everything at once.</span>
<span class="source-line-no">420</span><span id="line-420">        return(new DemandWithoutAndWithSetback(noSetback, withSetback));</span>
<span class="source-line-no">421</span><span id="line-421">            }</span>
<span class="source-line-no">422</span><span id="line-422"></span>
<span class="source-line-no">423</span><span id="line-423">    /**Compute 8-room 'detached' raw heat and heat-pump electricity demand with and without B-room setback (W).</span>
<span class="source-line-no">424</span><span id="line-424">     * The calculation uses constants from HGTRVHPMModel as far as possible,</span>
<span class="source-line-no">425</span><span id="line-425">     * substituting in parameters and new calculation where needed.</span>
<span class="source-line-no">426</span><span id="line-426">     *</span>
<span class="source-line-no">427</span><span id="line-427">     * @param params  the variable model parameters</span>
<span class="source-line-no">428</span><span id="line-428">     * @return  demand in watts, finite and non-negative</span>
<span class="source-line-no">429</span><span id="line-429">     */</span>
<span class="source-line-no">430</span><span id="line-430">    public static DemandWithoutAndWithSetback computeDetachedDemandW(final ModelParameters params)</span>
<span class="source-line-no">431</span><span id="line-431">        { return(computeDetachedDemandW(params, false)); }</span>
<span class="source-line-no">432</span><span id="line-432"></span>
<span class="source-line-no">433</span><span id="line-433">    /**Compute 8-room 'detached' raw heat and heat-pump electricity demand with and without B-room setback (W).</span>
<span class="source-line-no">434</span><span id="line-434">     * The calculation uses constants from HGTRVHPMModel as far as possible,</span>
<span class="source-line-no">435</span><span id="line-435">     * substituting in parameters and new calculation where needed.</span>
<span class="source-line-no">436</span><span id="line-436">     *</span>
<span class="source-line-no">437</span><span id="line-437">     * @param params  the variable model parameters</span>
<span class="source-line-no">438</span><span id="line-438">     * @param asBungalow  if true, compute as 4-room bungalow to cross-check with original calculation</span>
<span class="source-line-no">439</span><span id="line-439">     * @return  demand in watts, finite and non-negative</span>
<span class="source-line-no">440</span><span id="line-440">     */</span>
<span class="source-line-no">441</span><span id="line-441">    public static DemandWithoutAndWithSetback computeDetachedDemandW(final ModelParameters params,</span>
<span class="source-line-no">442</span><span id="line-442">                final boolean asBungalow)</span>
<span class="source-line-no">443</span><span id="line-443">            {</span>
<span class="source-line-no">444</span><span id="line-444">        Objects.requireNonNull(params);</span>
<span class="source-line-no">445</span><span id="line-445"></span>
<span class="source-line-no">446</span><span id="line-446">        // Do not allow model to be run with potentially implausible parameters.</span>
<span class="source-line-no">447</span><span id="line-447">        if(params.externalAirTemperatureC &gt;= HGTRVHPMModel.SETBACK_ROOM_TEMPERATURE_C)</span>
<span class="source-line-no">448</span><span id="line-448">            { throw new UnsupportedOperationException("model may not work when outside is warmer than setback rooms"); }</span>
<span class="source-line-no">449</span><span id="line-449"></span>
<span class="source-line-no">450</span><span id="line-450"></span>
<span class="source-line-no">451</span><span id="line-451">        // Roof area: as for bungalow.</span>
<span class="source-line-no">452</span><span id="line-452">        final double roofAreaM2 = HGTRVHPMModelExtensions.HOME_TOTAL_ROOF_AREA_M2;</span>
<span class="source-line-no">453</span><span id="line-453"></span>
<span class="source-line-no">454</span><span id="line-454">        // Number of rooms.</span>
<span class="source-line-no">455</span><span id="line-455">        final int numRooms = asBungalow ? 4 : 8;</span>
<span class="source-line-no">456</span><span id="line-456"></span>
<span class="source-line-no">457</span><span id="line-457">        // External wall area: as for bungalow in bungalow mode, else double.</span>
<span class="source-line-no">458</span><span id="line-458">        final double extWallAreaM2 = (asBungalow ? 1 : 2) *</span>
<span class="source-line-no">459</span><span id="line-459">                        HGTRVHPMModelExtensions.HOME_TOTAL_EXTERNAL_WALL_AREA_M2;</span>
<span class="source-line-no">460</span><span id="line-460"></span>
<span class="source-line-no">461</span><span id="line-461">        // Wall heat loss per K temperature differential between inside and out.</span>
<span class="source-line-no">462</span><span id="line-462">        final double homeHeatLossPerK = (roofAreaM2 + extWallAreaM2) *</span>
<span class="source-line-no">463</span><span id="line-463">                        HGTRVHPMModelExtensions.HOME_LOSSLESS_FLOOR_EXTERNAL_WALL_AND_ROOF_U_WpM2K;</span>
<span class="source-line-no">464</span><span id="line-464"></span>
<span class="source-line-no">465</span><span id="line-465">        // DHHLnsb: whole home heat loss with no setback (all rooms same temperature) and given external air temperature (W).</span>
<span class="source-line-no">466</span><span id="line-466">        final double DHHLnsb = (HGTRVHPMModel.NORMAL_ROOM_TEMPERATURE_C - params.externalAirTemperatureC()) *</span>
<span class="source-line-no">467</span><span id="line-467">                        homeHeatLossPerK;</span>
<span class="source-line-no">468</span><span id="line-468">        // HHLsb: whole home heat loss with B rooms setback and given external air temperature (W).</span>
<span class="source-line-no">469</span><span id="line-469">        final double DHHLsb = (HGTRVHPMModel.MEAN_HOME_TEMPERATURE_WITH_SETBACK_C - params.externalAirTemperatureC()) *</span>
<span class="source-line-no">470</span><span id="line-470">                        homeHeatLossPerK;</span>
<span class="source-line-no">471</span><span id="line-471">        // DradWnsb: pre-setback radiator output based on variable external air temperature (W).</span>
<span class="source-line-no">472</span><span id="line-472">        // (Was: RADIATOR_POWER_WITH_HOME_AT_NORMAL_ROOM_TEMPERATURE_W.)</span>
<span class="source-line-no">473</span><span id="line-473">                final double DradWnsb = DHHLnsb / numRooms;</span>
<span class="source-line-no">474</span><span id="line-474">//System.out.println(String.format("DradWnsb = %f", DradWnsb));</span>
<span class="source-line-no">475</span><span id="line-475"></span>
<span class="source-line-no">476</span><span id="line-476">                // HEAT LOSS 1</span>
<span class="source-line-no">477</span><span id="line-477">                // Internal wall heat loss/transfer per A room (W).</span>
<span class="source-line-no">478</span><span id="line-478">        final double DIWAabHLW = iwHeatLossPerA(params);</span>
<span class="source-line-no">479</span><span id="line-479">                // Internal floor/ceiling heat loss/transfer per A room (W).</span>
<span class="source-line-no">480</span><span id="line-480">        // None if a bungalow or if AABB arrangement on both floors,</span>
<span class="source-line-no">481</span><span id="line-481">        // ie no A and B share a ceiling/floor.</span>
<span class="source-line-no">482</span><span id="line-482">        final double DIFAabHLW =</span>
<span class="source-line-no">483</span><span id="line-483">                        (asBungalow || !params.roomsAlternatingABAB) ? 0 :</span>
<span class="source-line-no">484</span><span id="line-484">                                ifHeatLossPerA2Storey(params);</span>
<span class="source-line-no">485</span><span id="line-485">        // All internal heat losses per A room (W).</span>
<span class="source-line-no">486</span><span id="line-486">        final double DIFWAabHLW = DIWAabHLW + DIFAabHLW;</span>
<span class="source-line-no">487</span><span id="line-487"></span>
<span class="source-line-no">488</span><span id="line-488"></span>
<span class="source-line-no">489</span><span id="line-489">        // HEAT LOSS 2</span>
<span class="source-line-no">490</span><span id="line-490">        // DradAsbMW: (Heat Loss 2.5) radiator mean water temperature in each A room when B setback (C).</span>
<span class="source-line-no">491</span><span id="line-491">        final double DradAsbMW = sbAMW(DHHLsb, DradWnsb, DIFWAabHLW);</span>
<span class="source-line-no">492</span><span id="line-492">                // Extension to heat loss 2 to allow for varying external temperatures.</span>
<span class="source-line-no">493</span><span id="line-493">                // MW temperature for all room radiators with no setbacks.</span>
<span class="source-line-no">494</span><span id="line-494">        final double DradAnsbMW = nsbAMW(DradWnsb);</span>
<span class="source-line-no">495</span><span id="line-495"></span>
<span class="source-line-no">496</span><span id="line-496"></span>
<span class="source-line-no">497</span><span id="line-497">        final double CoPCorrectionK = params.correctCoPForFlowVsMW ? flowMWDelta_K : 0;</span>
<span class="source-line-no">498</span><span id="line-498"></span>
<span class="source-line-no">499</span><span id="line-499">                // HPinWnsb: (Heat Pump Efficiency) heat-pump electrical power in when B not setback (W).</span>
<span class="source-line-no">500</span><span id="line-500">        // (HEAT_PUMP_POWER_IN_NO_SETBACK_W)</span>
<span class="source-line-no">501</span><span id="line-501">        // Note that flow and mean temperatures seem to be being mixed here in the HG page.</span>
<span class="source-line-no">502</span><span id="line-502">        final double DCoPnsb = computeFlowCoP(DradAnsbMW + CoPCorrectionK);</span>
<span class="source-line-no">503</span><span id="line-503">//System.out.println(String.format("CoPnsb = %f", CoPnsb));</span>
<span class="source-line-no">504</span><span id="line-504">        final double DHPinWnsb =</span>
<span class="source-line-no">505</span><span id="line-505">                DHHLnsb / DCoPnsb;</span>
<span class="source-line-no">506</span><span id="line-506"></span>
<span class="source-line-no">507</span><span id="line-507">                // HPinWsb: (Heat Pump Efficiency) heat-pump electrical power in when B is setback (W).</span>
<span class="source-line-no">508</span><span id="line-508">        // (HEAT_PUMP_POWER_IN_B_SETBACK_W)</span>
<span class="source-line-no">509</span><span id="line-509">        // Note that flow and mean temperatures seem to be being mixed here in the HG page.</span>
<span class="source-line-no">510</span><span id="line-510">        final double DCoPsb = computeFlowCoP(DradAsbMW + CoPCorrectionK);</span>
<span class="source-line-no">511</span><span id="line-511">//System.out.println(String.format("CoPsb = %f", CoPsb));</span>
<span class="source-line-no">512</span><span id="line-512">        final double DHPinWsb =</span>
<span class="source-line-no">513</span><span id="line-513">                DHHLsb / DCoPsb;</span>
<span class="source-line-no">514</span><span id="line-514"></span>
<span class="source-line-no">515</span><span id="line-515"></span>
<span class="source-line-no">516</span><span id="line-516">        final HeatAndElectricityDemand noSetback = new HeatAndElectricityDemand(DHHLnsb, DHPinWnsb);</span>
<span class="source-line-no">517</span><span id="line-517">        final HeatAndElectricityDemand withSetback = new HeatAndElectricityDemand(DHHLsb, DHPinWsb);</span>
<span class="source-line-no">518</span><span id="line-518"></span>
<span class="source-line-no">519</span><span id="line-519">        // Return everything at once.</span>
<span class="source-line-no">520</span><span id="line-520">        return(new DemandWithoutAndWithSetback(noSetback, withSetback));</span>
<span class="source-line-no">521</span><span id="line-521">            }</span>
<span class="source-line-no">522</span><span id="line-522"></span>
<span class="source-line-no">523</span><span id="line-523"></span>
<span class="source-line-no">524</span><span id="line-524">    /**Compute raw heat and heat-pump electricity demand with and without setback, for 'soft' A temperature regulation (W).</span>
<span class="source-line-no">525</span><span id="line-525">     * This lets the A room temperature droop during B-room setback,</span>
<span class="source-line-no">526</span><span id="line-526">     * and does not raise the flow temperature.</span>
<span class="source-line-no">527</span><span id="line-527">     * &lt;p&gt;</span>
<span class="source-line-no">528</span><span id="line-528">     * This assumes that:</span>
<span class="source-line-no">529</span><span id="line-529">     * &lt;ul&gt;</span>
<span class="source-line-no">530</span><span id="line-530">     * &lt;li&gt;B room temperatures (and A room temperatures) are 'normal' (21C) without setback.&lt;/li&gt;</span>
<span class="source-line-no">531</span><span id="line-531">     * &lt;li&gt;B room temperatures are the expected 18C when set back.&lt;/li&gt;</span>
<span class="source-line-no">532</span><span id="line-532">     * &lt;li&gt;Flow temperature is pinned during setback to the temperature</span>
<span class="source-line-no">533</span><span id="line-533">     *     that maintained A and B rooms at 'normal' temperature without setback,</span>
<span class="source-line-no">534</span><span id="line-534">     *     ie as if the flow temperature is entirely driven by external temperature</span>
<span class="source-line-no">535</span><span id="line-535">     *     and thus weather compensation.&lt;/li&gt;</span>
<span class="source-line-no">536</span><span id="line-536">     * &lt;/ul&gt;</span>
<span class="source-line-no">537</span><span id="line-537">     * &lt;p&gt;</span>
<span class="source-line-no">538</span><span id="line-538">     * Note: this does not allow for the temperature delta across the radiator rising,</span>
<span class="source-line-no">539</span><span id="line-539">     * and thus the mean water (MW) temperature dropping further from the flow temperature,</span>
<span class="source-line-no">540</span><span id="line-540">     * as more heat is drawn by an A room below 'normal' temperature.</span>
<span class="source-line-no">541</span><span id="line-541">     *</span>
<span class="source-line-no">542</span><span id="line-542">     * @param params  the variable model parameters</span>
<span class="source-line-no">543</span><span id="line-543">     * @param bungalow  if true, compute as 4-room bungalow, else as 8-room detached</span>
<span class="source-line-no">544</span><span id="line-544">     * @param equilibriumTemperature  if not null and not zero length,</span>
<span class="source-line-no">545</span><span id="line-545">     *     used to return the A-room equilibrium temperature</span>
<span class="source-line-no">546</span><span id="line-546">     * @return  demand in watts, finite and non-negative</span>
<span class="source-line-no">547</span><span id="line-547">     */</span>
<span class="source-line-no">548</span><span id="line-548">    public static DemandWithoutAndWithSetback computeSoftATempDemandW(final ModelParameters params,</span>
<span class="source-line-no">549</span><span id="line-549">                final boolean bungalow,</span>
<span class="source-line-no">550</span><span id="line-550">                final double[] equilibriumTemperature)</span>
<span class="source-line-no">551</span><span id="line-551">            {</span>
<span class="source-line-no">552</span><span id="line-552">        Objects.requireNonNull(params);</span>
<span class="source-line-no">553</span><span id="line-553"></span>
<span class="source-line-no">554</span><span id="line-554">        // Do not allow model to be run with potentially implausible parameters.</span>
<span class="source-line-no">555</span><span id="line-555">        if(params.externalAirTemperatureC &gt;= HGTRVHPMModel.SETBACK_ROOM_TEMPERATURE_C)</span>
<span class="source-line-no">556</span><span id="line-556">            { throw new UnsupportedOperationException("model may not work when outside is warmer than setback rooms"); }</span>
<span class="source-line-no">557</span><span id="line-557"></span>
<span class="source-line-no">558</span><span id="line-558"></span>
<span class="source-line-no">559</span><span id="line-559">        // Roof area: as for bungalow.</span>
<span class="source-line-no">560</span><span id="line-560">        final double roofAreaM2 = HGTRVHPMModelExtensions.HOME_TOTAL_ROOF_AREA_M2;</span>
<span class="source-line-no">561</span><span id="line-561"></span>
<span class="source-line-no">562</span><span id="line-562">        // Number of rooms.</span>
<span class="source-line-no">563</span><span id="line-563">        final int numRooms = bungalow ? 4 : 8;</span>
<span class="source-line-no">564</span><span id="line-564"></span>
<span class="source-line-no">565</span><span id="line-565">        // External wall area: as for bungalow in bungalow mode, else double.</span>
<span class="source-line-no">566</span><span id="line-566">        final double extWallAreaM2 = (bungalow ? 1 : 2) *</span>
<span class="source-line-no">567</span><span id="line-567">                        HGTRVHPMModelExtensions.HOME_TOTAL_EXTERNAL_WALL_AREA_M2;</span>
<span class="source-line-no">568</span><span id="line-568"></span>
<span class="source-line-no">569</span><span id="line-569">        // Wall heat loss per K temperature differential between inside and out.</span>
<span class="source-line-no">570</span><span id="line-570">        final double homeHeatLossPerK = (roofAreaM2 + extWallAreaM2) *</span>
<span class="source-line-no">571</span><span id="line-571">                        HGTRVHPMModelExtensions.HOME_LOSSLESS_FLOOR_EXTERNAL_WALL_AND_ROOF_U_WpM2K;</span>
<span class="source-line-no">572</span><span id="line-572"></span>
<span class="source-line-no">573</span><span id="line-573">        // DHHLnsb: whole home heat loss with no setback (all rooms same temperature) and given external air temperature (W).</span>
<span class="source-line-no">574</span><span id="line-574">        final double DHHLnsb = (HGTRVHPMModel.NORMAL_ROOM_TEMPERATURE_C - params.externalAirTemperatureC()) *</span>
<span class="source-line-no">575</span><span id="line-575">                        homeHeatLossPerK;</span>
<span class="source-line-no">576</span><span id="line-576">//System.out.println(String.format("DHHLnsb = %.1f", DHHLnsb));</span>
<span class="source-line-no">577</span><span id="line-577"></span>
<span class="source-line-no">578</span><span id="line-578">        // DradWnsb: pre-setback radiator output based on variable external air temperature (W).</span>
<span class="source-line-no">579</span><span id="line-579">                final double DradWnsb = DHHLnsb / numRooms;</span>
<span class="source-line-no">580</span><span id="line-580">//System.out.println(String.format("DradWnsb = %f", DradWnsb));</span>
<span class="source-line-no">581</span><span id="line-581"></span>
<span class="source-line-no">582</span><span id="line-582">                // Extension to heat loss 2 to allow for varying external temperatures.</span>
<span class="source-line-no">583</span><span id="line-583">                // MW temperature for all room radiators with no setbacks.</span>
<span class="source-line-no">584</span><span id="line-584">        final double DradAnsbMW = nsbAMW(DradWnsb);</span>
<span class="source-line-no">585</span><span id="line-585">//System.out.println(String.format("DradAnsbMW = %.1f", DradAnsbMW));</span>
<span class="source-line-no">586</span><span id="line-586">        // Delta between radiator mean water (MW) and A room air.</span>
<span class="source-line-no">587</span><span id="line-587">                final double DradAsbdT = DradAnsbMW - HGTRVHPMModel.NORMAL_ROOM_TEMPERATURE_C;</span>
<span class="source-line-no">588</span><span id="line-588">//System.out.println(String.format("DradAsbdT = %.1fK", DradAsbdT));</span>
<span class="source-line-no">589</span><span id="line-589"></span>
<span class="source-line-no">590</span><span id="line-590">        final double CoPCorrectionK = params.correctCoPForFlowVsMW ? flowMWDelta_K : 0;</span>
<span class="source-line-no">591</span><span id="line-591"></span>
<span class="source-line-no">592</span><span id="line-592">                // HPinWnsb: (Heat Pump Efficiency) heat-pump electrical power in when B not setback (W).</span>
<span class="source-line-no">593</span><span id="line-593">        // (HEAT_PUMP_POWER_IN_NO_SETBACK_W)</span>
<span class="source-line-no">594</span><span id="line-594">        // Note that flow and mean temperatures seem to be being mixed here in the HG page.</span>
<span class="source-line-no">595</span><span id="line-595">        final double DCoPnsb = computeFlowCoP(DradAnsbMW + CoPCorrectionK);</span>
<span class="source-line-no">596</span><span id="line-596">        final double VCoPsb = DCoPnsb;</span>
<span class="source-line-no">597</span><span id="line-597">//System.out.println(String.format("DCoPnsb = VCoPsb = %f", DCoPnsb));</span>
<span class="source-line-no">598</span><span id="line-598">        final double DHPinWnsb =</span>
<span class="source-line-no">599</span><span id="line-599">                DHHLnsb / DCoPnsb;</span>
<span class="source-line-no">600</span><span id="line-600">//System.out.println(String.format("DHPinWnsb = %f", DHPinWnsb));</span>
<span class="source-line-no">601</span><span id="line-601"></span>
<span class="source-line-no">602</span><span id="line-602">        // Compute losses to outside for all B rooms when B setback.</span>
<span class="source-line-no">603</span><span id="line-603">        final double VBHLsb = (HGTRVHPMModel.SETBACK_ROOM_TEMPERATURE_C - params.externalAirTemperatureC()) *</span>
<span class="source-line-no">604</span><span id="line-604">                        (homeHeatLossPerK / 2);</span>
<span class="source-line-no">605</span><span id="line-605">//System.out.println(String.format("VBHLsb = %.1fW (%.1fW per B room))", VBHLsb, VBHLsb / (numRooms / 2)));</span>
<span class="source-line-no">606</span><span id="line-606"></span>
<span class="source-line-no">607</span><span id="line-607"></span>
<span class="source-line-no">608</span><span id="line-608">        // A-room temperature step in K.</span>
<span class="source-line-no">609</span><span id="line-609">        final double tempStepK = 0.1;</span>
<span class="source-line-no">610</span><span id="line-610"></span>
<span class="source-line-no">611</span><span id="line-611">        // Try all A room temperatures from setback up to and just above 'normal'</span>
<span class="source-line-no">612</span><span id="line-612">        // to find the minimum A room temperature where heat gains equal or exceed losses</span>
<span class="source-line-no">613</span><span id="line-613">        // and the whole house heat loss at that point.</span>
<span class="source-line-no">614</span><span id="line-614">        double VequilibriumTempA = 0;</span>
<span class="source-line-no">615</span><span id="line-615">        double VequilibriumHHLsb = 0;</span>
<span class="source-line-no">616</span><span id="line-616">        for(double tempA = HGTRVHPMModel.SETBACK_ROOM_TEMPERATURE_C;</span>
<span class="source-line-no">617</span><span id="line-617">                        tempA &lt;= HGTRVHPMModel.NORMAL_ROOM_TEMPERATURE_C + tempStepK;</span>
<span class="source-line-no">618</span><span id="line-618">                        tempA += tempStepK)</span>
<span class="source-line-no">619</span><span id="line-619">                {</span>
<span class="source-line-no">620</span><span id="line-620">//System.out.println(String.format("tempA = %.1fC", tempA));</span>
<span class="source-line-no">621</span><span id="line-621"></span>
<span class="source-line-no">622</span><span id="line-622">                // Compute losses to outside for all A rooms when B setback.</span>
<span class="source-line-no">623</span><span id="line-623">                final double VAHLsb = (tempA - params.externalAirTemperatureC()) *</span>
<span class="source-line-no">624</span><span id="line-624">                        (homeHeatLossPerK / 2);</span>
<span class="source-line-no">625</span><span id="line-625">//System.out.println(String.format("  VAHLsb = %.1fW", VAHLsb));</span>
<span class="source-line-no">626</span><span id="line-626">                final double VHHLsb = VAHLsb+VBHLsb;</span>
<span class="source-line-no">627</span><span id="line-627">//System.out.println(String.format("  VHHLsb = %.1fW", VHHLsb));</span>
<span class="source-line-no">628</span><span id="line-628"></span>
<span class="source-line-no">629</span><span id="line-629">                        // Losses to outside for each A room.</span>
<span class="source-line-no">630</span><span id="line-630">                        final double VAHLo = VAHLsb / (numRooms / 2);</span>
<span class="source-line-no">631</span><span id="line-631">//System.out.println(String.format("  VAHLo = %.1fW", VAHLo));</span>
<span class="source-line-no">632</span><span id="line-632"></span>
<span class="source-line-no">633</span><span id="line-633">                // HEAT LOSS 1</span>
<span class="source-line-no">634</span><span id="line-634">                // Internal wall heat loss/transfer per A room (W).</span>
<span class="source-line-no">635</span><span id="line-635">                final double VIWAabHLW = iwHeatLossPerA(params, tempA);</span>
<span class="source-line-no">636</span><span id="line-636">                // Internal floor/ceiling heat loss/transfer per A room (W).</span>
<span class="source-line-no">637</span><span id="line-637">                // None if a bungalow or if AABB arrangement on both floors,</span>
<span class="source-line-no">638</span><span id="line-638">                // ie no A and B share a ceiling/floor.</span>
<span class="source-line-no">639</span><span id="line-639">                final double VIFAabHLW =</span>
<span class="source-line-no">640</span><span id="line-640">                        (bungalow || !params.roomsAlternatingABAB) ? 0 :</span>
<span class="source-line-no">641</span><span id="line-641">                                ifHeatLossPerA2Storey(params, tempA);</span>
<span class="source-line-no">642</span><span id="line-642">            // All internal heat losses per A room (W).</span>
<span class="source-line-no">643</span><span id="line-643">                final double VIFWAabHLW = VIWAabHLW + VIFAabHLW;</span>
<span class="source-line-no">644</span><span id="line-644">//System.out.println(String.format("  VIFWAabHLW = %.1fW", VIFWAabHLW));</span>
<span class="source-line-no">645</span><span id="line-645"></span>
<span class="source-line-no">646</span><span id="line-646">                        // Total heat losses from each A room.</span>
<span class="source-line-no">647</span><span id="line-647">            final double VAHLW = VIFWAabHLW + VAHLo;</span>
<span class="source-line-no">648</span><span id="line-648">//System.out.println(String.format("  VAHLW = %.1fW", VAHLW));</span>
<span class="source-line-no">649</span><span id="line-649"></span>
<span class="source-line-no">650</span><span id="line-650">            // Input power from radiator to each A room given:</span>
<span class="source-line-no">651</span><span id="line-651">            //   * the A room temperature</span>
<span class="source-line-no">652</span><span id="line-652">            //   * same (weather-compensated) MW/flow temperature as without setbacks</span>
<span class="source-line-no">653</span><span id="line-653">            //</span>
<span class="source-line-no">654</span><span id="line-654">            // Delta between radiator mean water (MW) and A room air.</span>
<span class="source-line-no">655</span><span id="line-655">                        final double VradAsbdT = DradAnsbMW - tempA;</span>
<span class="source-line-no">656</span><span id="line-656">                        assert((VradAsbdT &gt; DradAsbdT) || (tempA &gt;= HGTRVHPMModel.NORMAL_ROOM_TEMPERATURE_C)) :</span>
<span class="source-line-no">657</span><span id="line-657">                                "When room is cooler than 'normal', delta must be higher.";</span>
<span class="source-line-no">658</span><span id="line-658">//System.out.println(String.format("  VradAsbdT = %.1fK", VradAsbdT));</span>
<span class="source-line-no">659</span><span id="line-659">            // Ratio to original non-setback delta.</span>
<span class="source-line-no">660</span><span id="line-660">            final double VardAsbdTmult = VradAsbdT / DradAsbdT;</span>
<span class="source-line-no">661</span><span id="line-661">//System.out.println(String.format("  VardAsbdTmult = %.2f", VardAsbdTmult));</span>
<span class="source-line-no">662</span><span id="line-662">            final double dtToWexp = 1 / HGTRVHPMModel.RADIATOR_EXP_POWER_TO_DT;</span>
<span class="source-line-no">663</span><span id="line-663">                        // Power output from rad in A room.</span>
<span class="source-line-no">664</span><span id="line-664">            final double VradWAmult =</span>
<span class="source-line-no">665</span><span id="line-665">                        VardAsbdTmult * Math.pow(VardAsbdTmult, dtToWexp);</span>
<span class="source-line-no">666</span><span id="line-666">//System.out.println(String.format("  VradWAmult = %.2f", VradWAmult));</span>
<span class="source-line-no">667</span><span id="line-667">                        // Power output from rad in A room (with B set back).</span>
<span class="source-line-no">668</span><span id="line-668">                        final double VradWAsb =</span>
<span class="source-line-no">669</span><span id="line-669">                                VradWAmult * DradWnsb;</span>
<span class="source-line-no">670</span><span id="line-670">//System.out.println(String.format("  VradWAsb = %.1fW", VradWAsb));</span>
<span class="source-line-no">671</span><span id="line-671">            // When room is cooler than 'normal', radiator output must be higher.</span>
<span class="source-line-no">672</span><span id="line-672">                        assert((VradWAsb &gt; DradWnsb) || (tempA &gt;= HGTRVHPMModel.NORMAL_ROOM_TEMPERATURE_C)) :</span>
<span class="source-line-no">673</span><span id="line-673">                                "When room is cooler than 'normal', radiator output must be higher.";</span>
<span class="source-line-no">674</span><span id="line-674"></span>
<span class="source-line-no">675</span><span id="line-675">            // Compute the error in each A-room heat gains and losses (+ve means excess heat in).</span>
<span class="source-line-no">676</span><span id="line-676">            final double VAHLerrW =</span>
<span class="source-line-no">677</span><span id="line-677">                        VradWAsb - VAHLW;</span>
<span class="source-line-no">678</span><span id="line-678">//System.out.println(String.format("  VAHLerrW = %.1fW", VAHLerrW));</span>
<span class="source-line-no">679</span><span id="line-679"></span>
<span class="source-line-no">680</span><span id="line-680">            // Stop when A-room gains exceed losses,</span>
<span class="source-line-no">681</span><span id="line-681">                        // thus returning (conservative, near) equilibrium values</span>
<span class="source-line-no">682</span><span id="line-682">            // from the previous step.</span>
<span class="source-line-no">683</span><span id="line-683">                        if(VAHLerrW &lt; 0)</span>
<span class="source-line-no">684</span><span id="line-684">                                { break; }</span>
<span class="source-line-no">685</span><span id="line-685"></span>
<span class="source-line-no">686</span><span id="line-686">                        // Record temperature and home heat loss</span>
<span class="source-line-no">687</span><span id="line-687">                        // when room A temperature below equilibrium point.</span>
<span class="source-line-no">688</span><span id="line-688">                        VequilibriumTempA = tempA;</span>
<span class="source-line-no">689</span><span id="line-689">                        VequilibriumHHLsb = VHHLsb;</span>
<span class="source-line-no">690</span><span id="line-690">                }</span>
<span class="source-line-no">691</span><span id="line-691"></span>
<span class="source-line-no">692</span><span id="line-692">        if(VequilibriumHHLsb &lt;= 0)</span>
<span class="source-line-no">693</span><span id="line-693">            { throw new RuntimeException("Failed to find solution"); }</span>
<span class="source-line-no">694</span><span id="line-694"></span>
<span class="source-line-no">695</span><span id="line-695">        // Return equilibrium temperature if possible.</span>
<span class="source-line-no">696</span><span id="line-696">        if((null != equilibriumTemperature) &amp;&amp; (0 != equilibriumTemperature.length))</span>
<span class="source-line-no">697</span><span id="line-697">                { equilibriumTemperature[0] = VequilibriumTempA; }</span>
<span class="source-line-no">698</span><span id="line-698"></span>
<span class="source-line-no">699</span><span id="line-699">//System.out.println(String.format("VequilibriumTempA = %.1fC @ external %.1fC", VequilibriumTempA, params.externalAirTemperatureC()));</span>
<span class="source-line-no">700</span><span id="line-700"></span>
<span class="source-line-no">701</span><span id="line-701">        // Compute electrical energy in given non-setback flow temperature CoP.</span>
<span class="source-line-no">702</span><span id="line-702">        final double VHPinWsb =</span>
<span class="source-line-no">703</span><span id="line-703">                VequilibriumHHLsb / VCoPsb;</span>
<span class="source-line-no">704</span><span id="line-704">//System.out.println(String.format("VHPinWsb = %.1fW", VHPinWsb));</span>
<span class="source-line-no">705</span><span id="line-705">//System.out.println(String.format("DHPinWnsb = %.1fW", DHPinWnsb));</span>
<span class="source-line-no">706</span><span id="line-706"></span>
<span class="source-line-no">707</span><span id="line-707">        final HeatAndElectricityDemand noSetback = new HeatAndElectricityDemand(DHHLnsb, DHPinWnsb);</span>
<span class="source-line-no">708</span><span id="line-708">        final HeatAndElectricityDemand withSetback = new HeatAndElectricityDemand(VequilibriumHHLsb, VHPinWsb);</span>
<span class="source-line-no">709</span><span id="line-709"></span>
<span class="source-line-no">710</span><span id="line-710">        // Return everything at once.</span>
<span class="source-line-no">711</span><span id="line-711">        return(new DemandWithoutAndWithSetback(noSetback, withSetback));</span>
<span class="source-line-no">712</span><span id="line-712">            }</span>
<span class="source-line-no">713</span><span id="line-713"></span>
<span class="source-line-no">714</span><span id="line-714">        }</span>




























































</pre>
</div>
</main>
</body>
</html>
